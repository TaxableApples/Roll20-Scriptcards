!scriptcard  {{
  --/|**********Customizable Variables***************
  --#overridetemplate|wizard
  --#title|Poison Spray
  --&SpellSaveType|Constitution
  --&SpellSaveDC|@{selected|spell_save_dc}
  --=NPCSaveMod|@{target|constitution_save_bonus}
  --=FeatDamage|0
  --&FeatDamageType|[FEAT]
  --=DamageDice|1d12
  --&DamageType|poison
  --&DamageFX|beam-slime
  --&Description|You extend your hand toward a creature you can see within range and project a puff of noxious gas from your palm. The creature must succeed on a Constitution saving throw or take 1d12 poison damage. This spell's damage increases by 1d12 when you reach 5th level (2d12), 11th level (3d12), and 17th level (4d12).

  --/|****************DO NOT CHANGE******************
  --#sourceToken|@{selected|token_id}
  --#targetToken|@{target|token_id}
  --#emoteText|@{selected|token_name}
  --=TargetSave|0
  --=Damage|0
  --=Resistance|0
  --=Immunity|0
  --=Vulnerability|0
  --=TotalDamage|0

  --/|*******************Main************************
  -->OutputSpellDC|
  -->RollDamage|
  -->MakeSavingThrow|
  --?[$TargetSave] -ge [&SpellSaveDC]|>Miss
  --?[$TargetSave] -lt [&SpellSaveDC]|>Hit
  --?"[*T:npc_resistances]" -inc [&DamageType]|>ApplyResistance
  --?"[*T:npc_immunities]" -inc [&DamageType]|>ApplyImmunity
  --?"[*T:npc_vulnerabilities]" -inc [&DamageType]|>ApplyVulnerability
  -->CalculateDamage|
  -->ApplyDamage|@{target|token_id};1;-[$TotalDamage]
  -->PlayEffects|
  --+|[rbutton]Show Description::OutputTxt[/rbutton]
  --X|
  
  --/|****************Subroutines********************
  --:OutputSpellDC|
    --+DC|[&SpellSaveDC] [&SpellSaveType] Saving Throw
  --<|

  --:RollDamage|
    --=Damage|[$DamageDice] + [$FeatDamage] [&FeatDamageType]
    --+Damage Roll|[$Damage]
  --<|

  --:MakeSavingThrow|
    --=TargetSave|1d20 + [$NPCSaveMod]
    --*|@{target|token_name} [&SpellSaveType] Save [$TargetSave]
  --<|
    
  --:ApplyResistance|
    --=Resistance|[$Damage] \ 2
    --*|Creature is resistant to [&DamageType] damage!
  --<|
  
  --:ApplyImmunity|
    --=Immunity|[$Damage]
    --*|Creature is immune to [&DamageType] damage!
  --<|
  
  --:ApplyVulnerability|
    --=Vulnerability|[$Damage]
    --*|Creature is vulnerable to [&DamageType] damage!
  --<|

  --:Hit|
    --*|Fails!
  --<|

  --:Miss|
    --=Damage|0
    --*|Succeeds!
  --<|
  
  --:PlayEffects|
    --vbetweentokens|@{selected|token_id} @{target|token_id} [&DamageFX]
  --<|
  
  --:CalculateDamage|
    --=TotalDamage|[$Damage]-[$Resistance]-[$Immunity]+[$Vulnerability]
    --*|Taking [$TotalDamage] Damage!
  --<|
  
  --:OutputTxt|
    --+|[f11][&Description][/f]
  --<|
  
  --:ApplyDamage|
    --@token-mod|_ignore-selected _ids [%1%] _set bar[%2%]_value|[%3%]
  --<|
}}